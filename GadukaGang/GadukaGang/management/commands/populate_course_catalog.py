from django.core.management.base import BaseCommand
from GadukaGang.models import (
    CourseCategory,
    Course,
    CourseSection,
    Lesson,
    ControlQuestion,
    ControlQuestionOption,
)


class Command(BaseCommand):
    help = "Populate course catalog with sections, lessons, and control tasks"

    @staticmethod
    def _build_long_lecture(course_title, section_title, lecture_title):
        return f"""# {lecture_title}

## Цель занятия
Это занятие курса **{course_title}** относится к блоку **{section_title}** и предназначено для детальной проработки темы.
После изучения материала вы сможете объяснить ключевые понятия, выделить типовые ошибки и применить подход в учебном или рабочем кейсе.

## Теоретическая основа
Любая прикладная тема требует структурного мышления: сначала мы определяем объект анализа, затем описываем ограничения, после этого выбираем инструменты и критерии качества результата.
В реальной практике ошибки появляются не из-за незнания терминов, а из-за отсутствия последовательности действий.
Поэтому в этом занятии акцент делается не только на понятия, но и на порядок выполнения работы.

Ключевые принципы:
1. Сначала формулируется измеримая цель и ожидаемый результат.
2. Затем фиксируются входные данные и ограничения.
3. Выбирается метод решения с учетом рисков и ресурсов.
4. Результат проверяется по заранее определенным критериям.
5. По итогам выполняется короткий ретроспективный анализ.

## Методика применения
Ниже приведена универсальная рабочая схема, которую рекомендуется использовать при выполнении домашних заданий и контрольных:

### Шаг 1. Подготовка контекста
- Зафиксируйте исходные данные и терминологию.
- Определите, какие данные достаточны для первого вывода.
- Уточните, какие показатели считаются критичными.

### Шаг 2. Формирование решения
- Разбейте задачу на подзадачи.
- На каждую подзадачу задайте вход, действие и ожидаемый выход.
- Проверяйте логику решения на небольших тестовых примерах.

### Шаг 3. Проверка качества
- Проверьте корректность результата на крайних сценариях.
- Сравните итог с критериями качества.
- Зафиксируйте, где решение устойчиво, а где требует доработки.

## Практические рекомендации
- Ведите короткий рабочий конспект: цель, шаги, результат, вывод.
- Не переходите к следующему этапу, пока не проверили предыдущий.
- Формулируйте выводы в формате «факт -> причина -> действие».
- Сохраняйте промежуточные версии решения, чтобы можно было вернуться к стабильной точке.
- В контрольной работе всегда отделяйте предположения от подтвержденных фактов.

## Разбор типичных ошибок
1. **Слишком ранние выводы**: решение принимается до проверки данных.
2. **Подмена цели**: студент решает «похожую», но не исходную задачу.
3. **Отсутствие критериев**: невозможно понять, решение качественное или нет.
4. **Игнорирование ограничений**: результат не применим в реальных условиях.
5. **Нет итоговой проверки**: пропускаются логические и технические ошибки.

## Кейс для самостоятельной проработки
Представьте, что вам нужно подготовить результат по теме «{lecture_title}» для команды или заказчика:
- Опишите цель в одном абзаце.
- Выпишите 5 ключевых параметров, которые влияют на решение.
- Подготовьте пошаговый план из 6-8 действий.
- Сформулируйте минимум 3 риска и варианты их снижения.
- Подготовьте короткий итоговый вывод, который можно отправить руководителю.

## Контрольные вопросы
1. Как определяется корректная цель в рамках темы занятия?
2. Почему важно задавать критерии качества до начала работы?
3. Какие ошибки чаще всего приводят к искажению результата?
4. Как проверить, что решение применимо на практике?
5. Какие данные необходимы для обоснованного вывода?

## Итоги занятия
В этом материале вы изучили расширенную модель работы с темой **{lecture_title}**: от постановки цели до проверки результата.
Перед переходом к следующей теме рекомендуется:
- сверить конспект с контрольными вопросами,
- повторно пройти пошаговую схему,
- подготовить черновик ответа для контрольной работы блока.

После этого переходите к следующему занятию раздела **{section_title}**.
"""

    @staticmethod
    def _build_control_content(section_title):
        return f"""# Контрольная работа: {section_title}

## Условия допуска
Контрольная работа обязательна. Пока она не выполнена, следующий блок курса недоступен.

## Задание 1. Теория (обязательно)
Подготовьте письменный ответ объемом не менее 1,5-2 страниц:
1. Раскройте ключевые понятия блока.
2. Сравните минимум два подхода к решению практической задачи.
3. Опишите типовые ошибки и способы их предотвращения.

## Задание 2. Практический кейс (обязательно)
Смоделируйте рабочую ситуацию по теме блока:
1. Определите цель и ограничения.
2. Составьте последовательность действий.
3. Обоснуйте выбор решений.
4. Представьте итог в формате отчета для руководителя.

## Задание 3. Самопроверка (обязательно)
Ответьте на вопросы:
1. Какие шаги в решении были ключевыми и почему?
2. Какие данные оказались критичными для качества результата?
3. Какие риски вы выявили и как их снизили?
4. Что вы бы улучшили в своей работе при повторном выполнении?

## Критерии оценки
- Полнота раскрытия темы.
- Логичность и обоснованность решений.
- Практическая применимость предложенного подхода.
- Качество структуры и формулировок.

## Результат
После выполнения контрольной работа считается пройденной, и система открывает следующий блок курса.
"""

    @staticmethod
    def _build_control_questions(course_title, section_title):
        return [
            {
                "type": "single",
                "prompt": f"Какая цель блока «{section_title}» в курсе «{course_title}» сформулирована корректно?",
                "options": [
                    ("Сразу перейти к итоговому проекту без анализа", False),
                    ("Построить последовательный процесс: цель, данные, метод, проверка", True),
                    ("Ограничиться чтением терминов без практики", False),
                    ("Сравнить только один подход без критериев качества", False),
                ],
            },
            {
                "type": "single",
                "prompt": "Какой этап обязательно должен идти перед выводами?",
                "options": [
                    ("Формализация критериев качества и проверка данных", True),
                    ("Публикация результата в чат", False),
                    ("Сразу выбор инструмента без постановки цели", False),
                    ("Пропуск анализа рисков", False),
                ],
            },
            {
                "type": "multiple",
                "prompt": "Выберите шаги, которые входят в корректную методику решения задачи.",
                "options": [
                    ("Фиксация ограничений и входных данных", True),
                    ("Проверка на крайних сценариях", True),
                    ("Игнорирование ошибок и допущений", False),
                    ("Итоговая ретроспектива после выполнения", True),
                ],
            },
            {
                "type": "multiple",
                "prompt": "Какие признаки указывают, что решение нельзя считать готовым?",
                "options": [
                    ("Нет критериев оценки результата", True),
                    ("Результат подтвержден тестовыми данными", False),
                    ("Отсутствует оценка рисков", True),
                    ("Проверены граничные случаи", False),
                ],
            },
            {
                "type": "single",
                "prompt": "Какой формат вывода считается профессиональным?",
                "options": [
                    ("Факт -> причина -> действие", True),
                    ("Мнение -> эмоция -> вывод", False),
                    ("Список терминов без структуры", False),
                    ("Только итог без обоснования", False),
                ],
            },
            {
                "type": "multiple",
                "prompt": "Выберите корректные действия перед сдачей контрольной.",
                "options": [
                    ("Повторить теорию по контрольным вопросам", True),
                    ("Проверить решение на тестовых примерах", True),
                    ("Удалить промежуточные результаты анализа", False),
                    ("Сопоставить итог с критериями качества", True),
                ],
            },
            {
                "type": "single",
                "prompt": "Что сильнее всего снижает качество результата?",
                "options": [
                    ("Ранние выводы без проверки фактов", True),
                    ("Пошаговая валидация решения", False),
                    ("Короткая письменная ретроспектива", False),
                    ("Сверка с ограничениями задачи", False),
                ],
            },
            {
                "type": "multiple",
                "prompt": "Какие артефакты должны остаться после качественного выполнения блока?",
                "options": [
                    ("Краткий план действий", True),
                    ("Список рисков и способ их снижения", True),
                    ("Сырые заметки без итогов и структуры", False),
                    ("Обоснованный итоговый вывод", True),
                ],
            },
            {
                "type": "text",
                "prompt": f"Опишите, как вы примените тему «{section_title}» в реальном кейсе. Укажите цель, ограничения, критерии качества, риски и итоговый план действий.",
                "min_words": 90,
                "keywords": ["цель", "огранич", "критер", "риск", "план", "вывод"],
            },
            {
                "type": "text",
                "prompt": "Сформулируйте разбор типичной ошибки студента и предложите пошаговый способ исправления с проверкой результата.",
                "min_words": 70,
                "keywords": ["ошиб", "причин", "шаг", "провер", "результат"],
            },
        ]

    def handle(self, *args, **options):
        categories_data = [
            ("IT-курсы", "Разработка, аналитика, безопасность и автоматизация.", 1),
            ("Экономика и финансы", "Экономика предприятия, учет и бюджетирование.", 2),
            ("Управление", "Проекты, продукты, команды и процессы.", 3),
            ("Маркетинг", "Стратегии продвижения и коммуникации.", 4),
            ("Аналитика данных", "BI, статистика и инструменты анализа.", 5),
            ("Ремесла и сервис", "Прикладные навыки для практических задач.", 6),
        ]

        categories = {}
        for name, desc, order in categories_data:
            category, _ = CourseCategory.objects.get_or_create(name=name)
            category.description = desc
            category.order = order
            category.save(update_fields=['description', 'order'])
            categories[name] = category

        practice_template = """def add(a, b):
    # TODO: верните сумму двух чисел
    return 0

if __name__ == "__main__":
    import sys
    data = sys.stdin.read().strip().split()
    if len(data) >= 2:
        a, b = int(data[0]), int(data[1])
        print(add(a, b))
"""

        practice_solution = """def add(a, b):
    return a + b

if __name__ == "__main__":
    import sys
    data = sys.stdin.read().strip().split()
    if len(data) >= 2:
        a, b = int(data[0]), int(data[1])
        print(add(a, b))
"""

        practice_tests = [
            {"input": "2 3", "output": "5"},
            {"input": "10 -4", "output": "6"},
        ]

        # preserve existing set of courses/taxonomy from previous version
        courses_data = [
            {"title":"Основы программирования на Python","category":"IT-курсы","description":"Логика программирования, базовые конструкции и решение задач на Python.","level":"Начальный","duration":8,"price":5900,"has_practice":True,"sections":[("Старт и синтаксис",["Переменные и типы данных","Условия и циклы"],True),("Функции и коллекции",["Списки, словари, множества","Функции и модули"],True),("Мини-проекты",["Работа с файлами","Итоговый мини-проект"],True)]},
            {"title":"Веб-разработка на Django","category":"IT-курсы","description":"Создание веб-приложений, работа с БД, шаблонами и админ-панелью.","level":"Средний","duration":10,"price":8900,"has_practice":True,"sections":[("Архитектура Django",["Проект и приложение","URL и представления"],True),("Данные и шаблоны",["Модели и миграции","Шаблоны и формы"],True),("Продакшн",["Авторизация и права","Деплой и безопасность"],True)]},
            {"title":"Аналитика данных на Python","category":"IT-курсы","description":"Pandas, визуализация и подготовка отчетов на основе данных.","level":"Средний","duration":9,"price":8200,"has_practice":True,"sections":[("Подготовка данных",["Импорт и очистка","Работа с таблицами"],True),("Аналитика",["Группировки и метрики","Визуализация"],True),("Отчеты",["Автоматизация отчетов","Проект по данным"],True)]},
            {"title":"SQL для аналитиков","category":"IT-курсы","description":"Запросы, агрегации и оптимизация работы с данными.","level":"Начальный","duration":6,"price":5400,"has_practice":True,"sections":[("Основы запросов",["SELECT и фильтрация","Сортировка и лимиты"],True),("Соединения",["JOIN-ы","Подзапросы"],True),("Практика",["Агрегации","Оптимизация запросов"],True)]},
            {"title":"Автоматизация бизнес-процессов","category":"IT-курсы","description":"Автоматизация рутинных задач, интеграции и отчеты.","level":"Средний","duration":7,"price":7600,"has_practice":True,"sections":[("Сценарии",["Автоматизация в офисе","Парсинг данных"],True),("Интеграции",["API и вебхуки","Работа с таблицами"],True),("Проект",["Сбор требований","Итоговая автоматизация"],True)]},
            {"title":"Основы кибербезопасности","category":"IT-курсы","description":"Риски, безопасность данных и практики защиты.","level":"Начальный","duration":6,"price":6200,"has_practice":True,"sections":[("Угрозы и атаки",["Модель угроз","Социальная инженерия"],True),("Защита",["Политики доступа","Шифрование"],True),("Инциденты",["План реагирования","Аудит безопасности"],True)]},
            {"title":"Экономика предприятия","category":"Экономика и финансы","description":"Формирование себестоимости, показатели эффективности и планирование.","level":"Начальный","duration":8,"price":6400,"has_practice":False,"sections":[("Базовые понятия",["Ресурсы предприятия","Себестоимость"],False),("Планирование",["Бюджет предприятия","Финансовые показатели"],False),("Анализ",["Рентабельность","Риски и устойчивость"],False)]},
            {"title":"Бюджетирование и финплан","category":"Экономика и финансы","description":"Построение бюджетов, контроль факта и анализ отклонений.","level":"Средний","duration":7,"price":6900,"has_practice":False,"sections":[("Финансовые циклы",["Потоки и бюджеты","Ответственность центров"],False),("Моделирование",["Сценарное планирование","Отчетность"],False),("Контроль",["Анализ отклонений","Оптимизация бюджета"],False)]},
            {"title":"Налоговый учет для бизнеса","category":"Экономика и финансы","description":"Системы налогообложения, документы и ответственность.","level":"Начальный","duration":6,"price":5200,"has_practice":False,"sections":[("Налоговые режимы",["УСН, ОСН, патент","Сроки и отчетность"],False),("Документы",["Первичка","Проверки"],False),("Практика",["Кейсы","Ошибки и риски"],False)]},
            {"title":"Управленческий учет","category":"Экономика и финансы","description":"Система учета для управленческих решений.","level":"Средний","duration":7,"price":7100,"has_practice":False,"sections":[("Структура учета",["Цели и методы","План счетов"],False),("Метрики",["Маржинальность","Unit-экономика"],False),("Отчеты",["P&L","Cash Flow"],False)]},
            {"title":"Управление проектами","category":"Управление","description":"Планирование, контроль рисков и управление командой.","level":"Средний","duration":8,"price":7800,"has_practice":False,"sections":[("Инициация",["Цели и ценность","Стейкхолдеры"],False),("Планирование",["WBS и график","Риски и бюджет"],False),("Исполнение",["Контроль изменений","Завершение"],False)]},
            {"title":"Управление продуктом","category":"Управление","description":"Жизненный цикл продукта, исследования и стратегия.","level":"Средний","duration":8,"price":8200,"has_practice":False,"sections":[("Discovery",["Интервью","Гипотезы"],False),("Delivery",["MVP","Аналитика"],False),("Рост",["Монетизация","Удержание"],False)]},
            {"title":"Организация продаж","category":"Управление","description":"Воронка продаж, KPI и управление отделом.","level":"Начальный","duration":6,"price":5600,"has_practice":False,"sections":[("Воронка",["Лиды и конверсии","Скрипты"],False),("Команда",["Планирование","Мотивация"],False),("Контроль",["Отчеты","Прогнозирование"],False)]},
            {"title":"HR-аналитика и подбор","category":"Управление","description":"Метрики HR, подбор и развитие персонала.","level":"Начальный","duration":6,"price":5400,"has_practice":False,"sections":[("Метрики",["Текучесть","Воронка кандидатов"],False),("Подбор",["Интервью","Оценка"],False),("Развитие",["Обучение","Планы роста"],False)]},
            {"title":"Цифровой маркетинг","category":"Маркетинг","description":"Стратегия продвижения, каналы и аналитика.","level":"Средний","duration":7,"price":6900,"has_practice":False,"sections":[("Стратегия",["Цели и аудитория","Позиционирование"],False),("Каналы",["Performance","Контент"],False),("Аналитика",["Метрики","Оптимизация"],False)]},
            {"title":"Бренд-стратегия","category":"Маркетинг","description":"Создание бренда и коммуникационной платформы.","level":"Средний","duration":6,"price":6400,"has_practice":False,"sections":[("Исследование",["ЦА","Конкуренты"],False),("Платформа",["Ценности","Архетип"],False),("Коммуникации",["Тональность","Гайдлайн"],False)]},
            {"title":"Контент-маркетинг","category":"Маркетинг","description":"Контент-стратегия, редакционный план и рост трафика.","level":"Начальный","duration":6,"price":5200,"has_practice":False,"sections":[("Стратегия",["Цели контента","Форматы"],False),("Производство",["Редакция","Процессы"],False),("Продвижение",["Дистрибуция","SEO"],False)]},
            {"title":"SMM и коммуникации","category":"Маркетинг","description":"Продвижение в соцсетях и работа с комьюнити.","level":"Начальный","duration":5,"price":4800,"has_practice":False,"sections":[("Площадки",["Выбор каналов","Контент-план"],False),("Комьюнити",["Модерация","Реакции"],False),("Аналитика",["Метрики","Отчеты"],False)]},
            {"title":"Excel для аналитики","category":"Аналитика данных","description":"Инструменты Excel для анализа и автоматизации отчетов.","level":"Начальный","duration":5,"price":4200,"has_practice":False,"sections":[("Базовые функции",["Формулы","Сводные"],False),("Анализ",["Диаграммы","Проверка данных"],False),("Автоматизация",["Макросы","Шаблоны"],False)]},
            {"title":"Power BI для менеджеров","category":"Аналитика данных","description":"Создание дашбордов и визуализация ключевых показателей.","level":"Средний","duration":6,"price":5600,"has_practice":False,"sections":[("Модели данных",["Источники","Связи"],False),("Визуализации",["Дашборды","Интерактив"],False),("Публикация",["Обновления","Доступы"],False)]},
            {"title":"Статистика для бизнеса","category":"Аналитика данных","description":"Гипотезы, выборки и интерпретация результатов.","level":"Средний","duration":6,"price":5400,"has_practice":False,"sections":[("Основы",["Распределения","Доверительные интервалы"],False),("Тесты",["A/B","Корреляции"],False),("Интерпретация",["Ошибки","Решения"],False)]},
            {"title":"Монтаж межкомнатных дверей","category":"Ремесла и сервис","description":"Практический курс по установке дверей, подбору материалов и инструментов.","level":"Начальный","duration":4,"price":3900,"has_practice":False,"sections":[("Подготовка",["Инструменты","Замеры"],False),("Установка",["Коробка","Навеска"],False),("Завершение",["Доборы","Проверка"],False)]},
            {"title":"Основы электромонтажа","category":"Ремесла и сервис","description":"Безопасность, схемы и базовые работы по электрике.","level":"Начальный","duration":5,"price":4300,"has_practice":False,"sections":[("Безопасность",["Нормы","Средства защиты"],False),("Схемы",["Проводка","Щитки"],False),("Монтаж",["Розетки","Освещение"],False)]},
            {"title":"Ремонт и отделка квартир","category":"Ремесла и сервис","description":"Подготовка поверхностей, материалы и контроль качества.","level":"Начальный","duration":6,"price":4600,"has_practice":False,"sections":[("Планирование",["Смета","Материалы"],False),("Отделка",["Стены","Пол"],False),("Контроль",["Приемка","Ошибки"],False)]},
            {"title":"Сервис клиентских услуг","category":"Ремесла и сервис","description":"Стандарты сервиса, работа с обращениями и лояльность.","level":"Начальный","duration":4,"price":3500,"has_practice":False,"sections":[("Сервис",["Стандарты","Скрипты"],False),("Обращения",["Сложные случаи","Эскалация"],False),("Лояльность",["NPS","Удержание"],False)]},
        ]

        active_titles = {item["title"] for item in courses_data}
        Course.objects.exclude(title__in=active_titles).update(is_active=False)

        for idx, course_data in enumerate(courses_data, start=1):
            course, _ = Course.objects.get_or_create(title=course_data["title"])
            course.category = categories[course_data["category"]]
            course.description = course_data["description"]
            course.level = course_data["level"]
            course.duration_weeks = course_data["duration"]
            course.price = course_data["price"]
            course.has_practice = course_data["has_practice"]
            course.order = idx
            course.is_active = True
            course.save()

            Lesson.objects.filter(course=course).delete()
            CourseSection.objects.filter(course=course).delete()

            order_counter = 1
            for section_index, (section_title, lecture_titles, include_practice) in enumerate(course_data["sections"], start=1):
                section = CourseSection.objects.create(
                    course=course,
                    title=section_title,
                    description=f"Блок {section_index}. {section_title}.",
                    order=section_index,
                )

                for lecture_title in lecture_titles:
                    Lesson.objects.create(
                        course=course,
                        section=section,
                        title=lecture_title,
                        content=self._build_long_lecture(course.title, section.title, lecture_title),
                        lesson_type='lecture',
                        order=order_counter,
                    )
                    order_counter += 1

                if course.has_practice and include_practice:
                    Lesson.objects.create(
                        course=course,
                        section=section,
                        title="Практическое задание",
                        content="## Практическая часть\n\nВыполните задание и убедитесь, что все тесты проходят успешно.",
                        lesson_type='practice',
                        order=order_counter,
                        practice_code_template=practice_template,
                        practice_solution=practice_solution,
                        test_cases=practice_tests,
                    )
                    order_counter += 1

                control_lesson = Lesson.objects.create(
                    course=course,
                    section=section,
                    title="Контрольная работа",
                    content=self._build_control_content(section.title),
                    lesson_type='control',
                    order=order_counter,
                    control_pass_threshold=70,
                    control_lock_minutes=10,
                )
                question_data = self._build_control_questions(course.title, section.title)
                for q_order, item in enumerate(question_data, start=1):
                    question = ControlQuestion.objects.create(
                        lesson=control_lesson,
                        question_type=item["type"],
                        prompt=item["prompt"],
                        order=q_order,
                        weight=2 if item["type"] == "text" else 1,
                        min_words=item.get("min_words", 20),
                        required_keywords=item.get("keywords", []),
                    )
                    for opt_order, option_item in enumerate(item.get("options", []), start=1):
                        option_text, is_correct = option_item
                        ControlQuestionOption.objects.create(
                            question=question,
                            option_text=option_text,
                            is_correct=is_correct,
                            order=opt_order,
                        )
                order_counter += 1

        self.stdout.write(self.style.SUCCESS("Course catalog populated."))
