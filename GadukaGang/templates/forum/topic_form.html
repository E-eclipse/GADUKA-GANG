{% extends 'base.html' %}
{% load static %}

{% block title %}{{ action }} тему - Plekhanov CourseHub{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
.topic-form-page { max-width: 980px; margin: 0 auto; }
.topic-form-card { padding: 28px; }
.topic-form-actions { display: flex; gap: 12px; margin-top: 20px; }
.topic-form-actions .btn { min-width: 180px; }
.tags-list { display: flex; flex-wrap: wrap; gap: 10px; }
.attachments-group { margin-top: 14px; }
.link-list { display: grid; gap: 8px; margin-top: 8px; }
</style>
{% endblock %}

{% block content %}
<section class="topic-form-page">
  <div class="card topic-form-card">
    <h2>{{ action }} тему</h2>
    <p class="help-text">Раздел: {{ section.name }}</p>

    <form method="post" enctype="multipart/form-data" id="topic-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.title.id_for_label }}">Заголовок</label>
        {{ form.title }}
      </div>

      {% if not topic and form.section %}
      <div class="form-group">
        <label for="{{ form.section.id_for_label }}">Раздел</label>
        {{ form.section }}
      </div>
      {% endif %}

      <div class="form-group">
        <label>Теги</label>
        <div class="tags-list">
          {% for tag in form.tags %}
            <label>{{ tag.tag }} {{ tag.choice_label }}</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label>{% if topic %}Первое сообщение темы{% else %}Содержание темы{% endif %}</label>
        <div class="rich-editor-wrap"><div id="topic-editor"></div></div>
        <input type="hidden" name="post_content" id="post_content">
      </div>

      <div class="form-group attachments-group">
        <label for="attachments">Файлы / фото / видео</label>
        <input id="attachments" name="attachments" type="file" multiple>
      </div>

      {% if topic and existing_attachments %}
      <div class="form-group attachments-group">
        <label>Уже прикрепленные файлы</label>
        <div class="attachment-list">
          {% for a in existing_attachments %}
          <label class="attachment-chip" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" name="remove_attachment_ids" value="{{ a.id }}">
            Удалить: {{ a.title|default:a.file.name|default:a.external_url }}
          </label>
          {% endfor %}
        </div>
        <small class="help-text">Отметьте вложения, которые нужно удалить при сохранении.</small>
      </div>
      {% endif %}

      <div class="form-group attachments-group">
        <label>Ссылки (по одной на строку)</label>
        <textarea name="external_links" rows="3" placeholder="https://example.com/video\nhttps://example.com/file.pdf"></textarea>
      </div>

      <div class="topic-form-actions">
        <a href="{% url 'topics_list' section.id %}" class="btn btn-secondary">Отмена</a>
        <button type="submit" class="btn btn-primary">{{ action }} тему</button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
(() => {
  const initialContent = `{% if topic and first_post %}{{ first_post.content|escapejs }}{% endif %}`;
  const quill = new Quill('#topic-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ color: [] }, { background: [] }],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link', 'blockquote', 'code-block'],
        ['clean']
      ]
    }
  });
  if (initialContent) {
    quill.root.innerHTML = initialContent;
  }
  document.getElementById('topic-form').addEventListener('submit', function () {
    document.getElementById('post_content').value = quill.root.innerHTML;
  });
})();
</script>
{% endblock %}
