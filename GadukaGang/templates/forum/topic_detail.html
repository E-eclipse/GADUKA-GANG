{% extends 'base.html' %}
{% load static %}

{% block title %}{{ topic.title }} - Gaduka Gang{% endblock %}

{% block content %}
<section class="forum-layout topic-view">
    <nav class="breadcrumb-line">
        <a href="{% url 'sections_list' %}">–†–∞–∑–¥–µ–ª—ã</a>
        <span>/</span>
        <a href="{% url 'topics_list' topic.section.id %}">{{ topic.section.name }}</a>
        <span>/</span>
        <span>{{ topic.title }}</span>
    </nav>

    <article class="topic-summary">
        <header class="topic-summary__header">
            <h1>{{ topic.title }}</h1>
            <div class="topic-summary__meta">
                <span>–ê–≤—Ç–æ—Ä: <a href="#">{{ topic.author.username }}</a></span>
                <span>–°–æ–∑–¥–∞–Ω–æ: {{ topic.created_date|date:"d.m.Y H:i" }}</span>
                <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {{ topic.view_count }}</span>
                {% if topic.average_rating > 0 %}
                <span>‚≠ê {{ topic.average_rating|floatformat:1 }} ‚Ä¢ {{ topic.rating_count }} –æ—Ü–µ–Ω–æ–∫</span>
                {% endif %}
            </div>
            {% if topic_tags %}
            <div class="topic-summary__tags">
                {% for tag in topic_tags %}
                <span class="badge tag-badge" style="color: {{ tag.color }}; border-color: {{ tag.color }};">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </header>
        {% if user.is_authenticated %}
        <div class="topic-summary__actions">
            <a href="{% url 'post_create' topic.id %}" class="btn btn-primary">–û—Ç–≤–µ—Ç–∏—Ç—å</a>
            {% if topic.author == user or user.is_staff or user.is_superuser %}
            <a href="{% url 'topic_edit' topic.id %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <form method="post" action="{% url 'topic_delete' topic.id %}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–µ–º—É?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </article>

    {% if user.is_authenticated %}
    <section class="rating-box">
        <div class="rating-box__title">
            <strong>–û—Ü–µ–Ω–∏—Ç–µ —Ç–µ–º—É</strong>
            <span class="rating-info">{{ topic.average_rating|floatformat:1 }} –∏–∑ 5 ‚Ä¢ {{ topic.rating_count }} –æ—Ü–µ–Ω–æ–∫</span>
        </div>
        <div class="star-rating" data-topic-id="{{ topic.id }}">
            {% for i in "12345" %}
            <span class="star" data-rating="{{ i }}">‚≠ê</span>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <div class="posts-stack">
        {% for post in page_obj %}
        <article class="post" id="post-{{ post.id }}">
            <header class="post__header">
                <div class="avatar">{{ post.author.username|first|upper }}</div>
                <div class="post__meta">
                    <strong><a href="#">{{ post.author.username }}</a></strong>
                    <span>{{ post.created_date|date:"d.m.Y H:i" }}</span>
                    {% if post.last_edited_date %}
                    <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ {{ post.last_edited_date|date:"d.m.Y H:i" }} ¬∑ {{ post.edit_count }}</span>
                    {% endif %}
                </div>
            </header>
            <div class="post__content">
                {% if post.content_html %}
                    {{ post.content_html }}
                {% else %}
                    {{ post.content|linebreaks }}
                {% endif %}
            </div>
            <footer class="post__footer">
                <div class="post__reactions">
                    {% if user.is_authenticated %}
                    <button class="reaction-btn like-btn" data-post-id="{{ post.id }}" data-like-type="like">
                        üëç <span class="like-count">{{ post.like_count }}</span>
                    </button>
                    <button class="reaction-btn dislike-btn" data-post-id="{{ post.id }}" data-like-type="dislike">
                        üëé <span class="dislike-count">{{ post.dislike_count }}</span>
                    </button>
                    {% endif %}
                </div>
                <div class="post__actions">
                    {% if post.author == user or user.is_staff or user.is_superuser %}
                    <a href="{% url 'post_edit' post.id %}" class="btn btn-sm btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form method="post" action="{% url 'post_delete' post.id %}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                    {% endif %}
                </div>
            </footer>
        </article>
        {% empty %}
        <div class="empty-panel">
            <p>–í —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. {% if user.is_authenticated %}<a href="{% url 'post_create' topic.id %}">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</a>.{% endif %}</p>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page=1" class="btn btn-sm">–ü–µ—Ä–≤–∞—è</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-sm">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        {% endif %}

        <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-sm">–°–ª–µ–¥—É—é—â–∞—è</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-sm">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
        {% endif %}
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
    document.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const likeType = this.dataset.likeType;
            const formData = new FormData();
            formData.append('like_type', likeType);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/api/posts/${postId}/like/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`#post-${postId} .like-count`).textContent = data.like_count;
                    document.querySelector(`#post-${postId} .dislike-count`).textContent = data.dislike_count;
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ç–µ–º
    document.querySelectorAll('.star-rating .star').forEach(star => {
        star.addEventListener('click', function() {
            const topicId = this.closest('.star-rating').dataset.topicId;
            const rating = this.dataset.rating;
            const formData = new FormData();
            formData.append('rating', rating);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/api/topics/${topicId}/rating/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector('.rating-info').textContent =
                        `${data.average_rating} –∏–∑ 5 ‚Ä¢ ${data.rating_count} –æ—Ü–µ–Ω–æ–∫`;
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–≤–µ–∑–¥
                    document.querySelectorAll('.star-rating .star').forEach((s, idx) => {
                        if (idx < rating) {
                            s.style.opacity = '1';
                        } else {
                            s.style.opacity = '0.3';
                        }
                    });
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}

