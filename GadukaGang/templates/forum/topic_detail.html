{% extends 'base.html' %}
{% load static %}

{% block title %}{{ topic.title }} - Plekhanov CourseHub{% endblock %}

{% block content %}
<div class="forum-container topic-detail-page">
    <div class="forum-header">
        <div class="forum-header-content">
            <nav class="breadcrumb">
                {% if community %}
                <a href="{% url 'community_list' %}">–°–æ–æ–±—â–µ—Å—Ç–≤–∞</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{% url 'community_detail' community.id %}">{{ community.name }}</a>
                {% else %}
                <a href="{% url 'sections_list' %}">–†–∞–∑–¥–µ–ª—ã</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{% url 'topics_list' topic.section.id %}">{{ topic.section.name }}</a>
                {% endif %}
                <span class="breadcrumb-separator">/</span>
                <span>{{ topic.title }}</span>
            </nav>
            <h1 class="forum-title">{{ topic.title }}</h1>
            <div class="topic-meta-row">
                <span><i class="fas fa-user"></i> {{ topic.author.username }}</span>
                <span><i class="far fa-clock"></i> {{ topic.created_date|date:"d.m.Y H:i" }}</span>
                <span><i class="far fa-eye"></i> {{ topic.view_count }}</span>
                {% if topic.average_rating > 0 %}
                <span><i class="fas fa-star"></i> {{ topic.average_rating|floatformat:1 }} ({{ topic.rating_count }})</span>
                {% endif %}
            </div>
            {% if topic_tags %}
            <div class="topic-tags" style="margin-top:10px;">
                {% for tag in topic_tags %}
                <a href="{% url 'topics_by_tag' tag.id %}" class="tag-badge">#{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% if user.is_authenticated %}
        <div class="forum-actions">
            <a href="{% url 'post_create' topic.id %}" class="btn btn-primary">
                <i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
            </a>
            {% if topic.author == user or user.is_staff or user.is_superuser %}
            <a href="{% url 'topic_edit' topic.id %}" class="btn btn-secondary">
                <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <form method="post" action="{% url 'topic_delete' topic.id %}?next={{ request.get_full_path|urlencode }}"
                onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–µ–º—É?');" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline">
                    <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="topic-posts">
        {% for post in page_obj %}
        <article class="topic-post-card" id="post-{{ post.id }}">
            <header class="topic-post-header">
                <div class="topic-post-author">
                    <div class="author-avatar">{{ post.author.username|first|upper }}</div>
                    <div class="author-meta">
                        <a href="#" class="author-link">{{ post.author.username }}</a>
                        <span class="post-date">{{ post.created_date|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
                <div class="topic-post-tools">
                    <a href="#post-{{ post.id }}" class="btn btn-secondary btn-sm">#{{ forloop.counter }}</a>
                    {% if user.is_authenticated %}
                    {% if post.author == user or user.is_staff or user.is_superuser %}
                    <a href="{% url 'post_edit' post.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-edit"></i>
                    </a>
                    <form method="post" action="{% url 'post_delete' post.id %}?next={{ request.get_full_path|urlencode }}"
                        onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                </div>
            </header>

            <div class="topic-post-content">
                {% if post.content_html %}
                {{ post.content_html|safe }}
                {% else %}
                {{ post.content|linebreaks }}
                {% endif %}
            </div>

            {% if post.attachments %}
            <div class="attachment-list">
                {% for a in post.attachments %}
                {% if a.kind == 'link' %}
                <a class="attachment-chip" href="{{ a.external_url }}" target="_blank" rel="noopener">{{ a.title|default:a.external_url }}</a>
                {% elif a.kind == 'image' %}
                <a class="attachment-chip" href="{{ a.file.url }}" data-attachment-kind="image" data-attachment-title="{{ a.title|default:'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }}">üñº {{ a.title|default:'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }}</a>
                {% elif a.kind == 'video' %}
                <a class="attachment-chip" href="{{ a.file.url }}" data-attachment-kind="video" data-attachment-title="{{ a.title|default:'–í–∏–¥–µ–æ' }}">üé¨ {{ a.title|default:'–í–∏–¥–µ–æ' }}</a>
                {% else %}
                <a class="attachment-chip" href="{% url 'attachment_download' a.id %}" data-attachment-kind="file" data-attachment-title="{{ a.title|default:'–§–∞–π–ª' }}">üìé {{ a.title|default:'–§–∞–π–ª' }}</a>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            {% if post.last_edited_date %}
            <footer class="topic-post-footer">
                <i class="fas fa-pencil-alt"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ {{ post.last_edited_date|date:"d.m.Y H:i" }} (–ø—Ä–∞–≤–æ–∫: {{ post.edit_count }})
            </footer>
            {% endif %}
        </article>
        {% empty %}
        <div class="empty-state">
            <div class="empty-state-icon"><i class="far fa-comment-dots"></i></div>
            <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
            <p>–í —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª.</p>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination">
        <div class="pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</div>
        <div class="pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?page=1" class="btn btn-secondary btn-sm"><i class="fas fa-angle-double-left"></i></a>
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary btn-sm"><i class="fas fa-angle-left"></i></a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary btn-sm"><i class="fas fa-angle-right"></i></a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary btn-sm"><i class="fas fa-angle-double-right"></i></a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <section class="topic-rating-card card">
        <h3>–û—Ü–µ–Ω–∏—Ç–µ —Ç–µ–º—É</h3>
        <div class="rating-container">
            <div class="stars-container" data-topic-id="{{ topic.id }}">
                {% for i in "12345" %}
                <button class="star-button" type="button" data-rating="{{ i }}"><i class="fas fa-star"></i></button>
                {% endfor %}
            </div>
            <div class="rating-info">{{ topic.average_rating|floatformat:1 }} –∏–∑ 5 ‚Ä¢ {{ topic.rating_count }} –æ—Ü–µ–Ω–æ–∫</div>
        </div>
    </section>
    {% endif %}

    {% if user.is_authenticated %}
    <section class="card">
        <h3>–í–∞—à –æ—Ç–≤–µ—Ç</h3>
        <p class="help-text">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç.</p>
        <a href="{% url 'post_create' topic.id %}" class="btn btn-primary">–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç</a>
    </section>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-lock"></i></div>
        <p>–ß—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å –≤ —Ç–µ–º–∞—Ö –∏ —Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.</p>
        <div class="forum-actions" style="justify-content:center; margin-top:10px;">
            <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">–í–æ–π—Ç–∏</a>
            <a href="{% url 'register' %}" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.star-button').forEach(star => {
    star.addEventListener('click', function () {
        const container = this.closest('.stars-container');
        const topicId = container.dataset.topicId;
        const rating = this.dataset.rating;
        const formData = new FormData();
        formData.append('rating', rating);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/api/topics/${topicId}/rating/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('.rating-info').textContent = `${data.average_rating} –∏–∑ 5 ‚Ä¢ ${data.rating_count} –æ—Ü–µ–Ω–æ–∫`;
                container.querySelectorAll('.star-button').forEach((s, idx) => {
                    if (idx < rating) s.classList.add('active');
                    else s.classList.remove('active');
                });
            }
        })
        .catch(() => {});
    });
});
</script>
{% endblock %}
