{% extends 'base.html' %}
{% load static %}

{% block title %}{{ topic.title }} - Gaduka Gang{% endblock %}

{% block content %}
<div class="cyber-container">
    <!-- Breadcrumbs -->
    <nav class="cyber-breadcrumbs">
        <a href="{% url 'sections_list' %}">Разделы</a>
        <span class="breadcrumb-separator">/</span>
        <a href="{% url 'topics_list' topic.section.id %}">{{ topic.section.name }}</a>
        <span class="breadcrumb-separator">/</span>
        <span class="current-page">{{ topic.title }}</span>
    </nav>

    <!-- Topic Header -->
    <header class="cyber-topic-header">
        <div class="topic-title-section">
            <h1 class="topic-title">{{ topic.title }}</h1>
            <div class="topic-meta-info">
                <div class="meta-item">
                    <i class="fas fa-user cyber-icon"></i>
                    <span>Автор: <a href="#" class="author-link">{{ topic.author.username }}</a></span>
                </div>
                <div class="meta-item">
                    <i class="far fa-clock cyber-icon"></i>
                    <span>{{ topic.created_date|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="meta-item">
                    <i class="far fa-eye cyber-icon"></i>
                    <span>Просмотров: {{ topic.view_count }}</span>
                </div>
                {% if topic.average_rating > 0 %}
                <div class="meta-item">
                    <i class="fas fa-star cyber-icon"></i>
                    <span>{{ topic.average_rating|floatformat:1 }} ({{ topic.rating_count }} оценок)</span>
                </div>
                {% endif %}
            </div>
        </div>

        {% if topic_tags %}
        <div class="topic-tags-section">
            {% for tag in topic_tags %}
            <a href="{% url 'topics_by_tag' tag.id %}" class="cyber-tag" style="--tag-color: {{ tag.color }}">
                <span class="tag-hash">#</span> {{ tag.name }}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {% if user.is_authenticated %}
        <div class="topic-actions">
            <a href="#reply-form" class="cyber-button primary">
                <i class="fas fa-reply"></i> Ответить
            </a>
            {% if topic.author == user or user.is_staff or user.is_superuser %}
            <a href="{% url 'topic_edit' topic.id %}" class="cyber-button secondary">
                <i class="fas fa-edit"></i> Редактировать
            </a>
            <form method="post" action="{% url 'topic_delete' topic.id %}"
                onsubmit="return confirm('Вы уверены, что хотите удалить эту тему?');" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="cyber-button danger">
                    <i class="fas fa-trash-alt"></i> Удалить
                </button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </header>

    <!-- Posts List -->
    <div class="cyber-posts-container">
        {% for post in page_obj %}
        <article class="cyber-post-card" id="post-{{ post.id }}">
            <div class="post-header">
                <div class="post-author-info">
                    <div class="author-avatar">
                        {{ post.author.username|first|upper }}
                    </div>
                    <div class="author-details">
                        <a href="#" class="author-name">{{ post.author.username }}</a>
                        <span class="post-date">{{ post.created_date|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
                <div class="post-actions">
                    <a href="#post-{{ post.id }}" class="cyber-button small outline">#{{ forloop.counter }}</a>
                </div>
            </div>

            <div class="post-content">
                {% if post.content_html %}
                {{ post.content_html|safe }}
                {% else %}
                {{ post.content|linebreaks }}
                {% endif %}
            </div>

            {% if post.last_edited_date %}
            <div class="post-edit-info">
                <i class="fas fa-pencil-alt"></i> Редактировано {{ post.last_edited_date|date:"d.m.Y H:i" }} (всего
                правок: {{ post.edit_count }})
                </span>
                {% endif %}
            </div>

            <div class="post-links">
                {% if user.is_authenticated %}
                {% if post.author == user or user.is_staff or user.is_superuser %}
                <a href="{% url 'post_edit' post.id %}" class="cyber-button small secondary">
                    <i class="fas fa-edit"></i>
                </a>
                <form method="post" action="{% url 'post_delete' post.id %}"
                    onsubmit="return confirm('Вы уверены, что хотите удалить это сообщение?');"
                    style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="cyber-button small danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
                {% endif %}
                {% endif %}
            </div>
            </footer>
        </article>
        {% empty %}
        <div class="cyber-empty-state">
            <div class="empty-icon">
                <i class="far fa-comment-dots"></i>
            </div>
            <h3>Нет сообщений</h3>
            <p>В этой теме пока никто не ответил. Будьте первым!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="cyber-pagination">
        <div class="pagination-info">
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
        </div>
        <div class="pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?page=1" class="cyber-button small secondary">Первая</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="cyber-button small secondary">Назад</a>
            {% endif %}

            <span class="current-page-info">{{ page_obj.number }}</span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="cyber-button small secondary">Вперед</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="cyber-button small secondary">Последняя</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Rating Section -->
    {% if user.is_authenticated %}
    <section class="cyber-topic-rating">
        <h3 class="rating-title">Оцените тему</h3>
        <div class="rating-container">
            <div class="stars-container" data-topic-id="{{ topic.id }}">
                {% for i in "12345" %}
                <button class="star-button" data-rating="{{ i }}">
                    <i class="fas fa-star"></i>
                </button>
                {% endfor %}
            </div>
            <div class="rating-info">
                {{ topic.average_rating|floatformat:1 }} из 5 • {{ topic.rating_count }} оценок
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Reply Form -->
    {% if user.is_authenticated %}
    <section id="reply-form" class="cyber-reply-form">
        <h3 class="form-title">Ваш ответ</h3>
        <form method="post" action="{% url 'post_create' topic.id %}">
            {% csrf_token %}
            <div class="form-group">
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Нажмите кнопку ниже, чтобы написать ответ.
                </p>
                <a href="{% url 'post_create' topic.id %}" class="cyber-button primary">Написать ответ</a>
            </div>
        </form>
    </section>
    {% else %}
    <div class="cyber-login-prompt">
        <div class="empty-icon">
            <i class="fas fa-lock"></i>
        </div>
        <p>Чтобы отвечать в темах и ставить оценки, необходимо авторизоваться.</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <a href="{% url 'login' %}?next={{ request.path }}" class="cyber-button primary">Войти</a>
            <a href="{% url 'register' %}" class="cyber-button secondary">Регистрация</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Обработка лайков/дизлайков
    document.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const postId = this.dataset.postId;
            const likeType = this.dataset.likeType;
            const formData = new FormData();
            formData.append('like_type', likeType);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/api/posts/${postId}/like/`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update counts
                        const postCard = document.getElementById(`post-${postId}`);
                        postCard.querySelector('.like-count').textContent = data.like_count;
                        postCard.querySelector('.dislike-count').textContent = data.dislike_count;

                        // Toggle active class
                        if (likeType === 'like') {
                            this.classList.toggle('active');
                            postCard.querySelector('.dislike-btn').classList.remove('active');
                        } else {
                            this.classList.toggle('active');
                            postCard.querySelector('.like-btn').classList.remove('active');
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });

    // Обработка рейтинга тем
    document.querySelectorAll('.star-button').forEach(star => {
        star.addEventListener('click', function () {
            const container = this.closest('.stars-container');
            const topicId = container.dataset.topicId;
            const rating = this.dataset.rating;
            const formData = new FormData();
            formData.append('rating', rating);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/api/topics/${topicId}/rating/`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('.rating-info').textContent =
                            `${data.average_rating} из 5 • ${data.rating_count} оценок`;

                        // Подсветка выбранных звезд
                        container.querySelectorAll('.star-button').forEach((s, idx) => {
                            if (idx < rating) {
                                s.classList.add('active');
                                s.style.color = 'var(--warning)';
                            } else {
                                s.classList.remove('active');
                                s.style.color = 'var(--text-secondary)';
                            }
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}