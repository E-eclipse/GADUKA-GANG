{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог курсов — Plekhanov CourseHub{% endblock %}

{% block extra_css %}
<style>
    .catalog-hero {
        background: var(--bg-card);
        border-radius: 24px;
        border: 1px solid var(--border-color);
        padding: 40px;
        box-shadow: 0 20px 40px rgba(19, 32, 62, 0.08);
        margin-bottom: 30px;
    }

    .catalog-hero h1 {
        font-family: var(--font-heading);
        font-size: 2.5rem;
        color: var(--accent-blue);
        margin-bottom: 12px;
    }

    .catalog-hero p {
        color: var(--text-secondary);
        max-width: 760px;
    }

    .catalog-search {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        margin-top: 20px;
    }

    .category-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 24px 0 32px;
    }

    .category-filter a {
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        text-decoration: none;
        color: var(--accent-blue);
        font-weight: 600;
        background: var(--bg-card);
    }

    .category-filter a.active {
        background: var(--accent-blue);
        color: var(--accent-contrast);
        border-color: transparent;
    }

    .course-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
    }

    .course-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 18px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 16px 30px rgba(19, 32, 62, 0.08);
    }

    .course-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .course-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: auto;
    }

    .course-price {
        font-weight: 700;
        color: var(--accent-blue);
    }

    .catalog-pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 28px 0 12px;
        flex-wrap: wrap;
    }

    .page-numbers {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .page-number {
        min-width: 36px;
        height: 36px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: var(--text-primary);
        background: var(--bg-card);
        font-weight: 600;
    }

    .page-number.active {
        background: var(--accent-blue);
        color: var(--accent-contrast);
        border-color: transparent;
    }

    .load-more-wrap {
        display: flex;
        justify-content: center;
        margin: 10px 0 0;
    }

    @media (max-width: 700px) {
        .catalog-search {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="catalog-hero">
    <h1>Каталог курсов</h1>
    <p>Выберите программу дополнительного образования. В каждом курсе есть разделы, контрольные работы и блоки практики.</p>
    <form method="get" class="catalog-search">
        <input type="search" name="q" placeholder="Поиск по курсам и категориям" value="{{ query }}">
        <button type="submit" class="btn btn-primary">Найти</button>
    </form>
</section>

<div class="category-filter">
    <a href="{% url 'education_courses' %}?q={{ query }}" class="{% if not selected_category %}active{% endif %}">Все направления</a>
    {% for category in categories %}
        <a href="{% url 'education_courses' %}?q={{ query }}&category={{ category.id }}" class="{% if selected_category == category.id %}active{% endif %}">{{ category.name }}</a>
    {% endfor %}
</div>

<section class="course-grid" id="course-grid">
    {% include 'education/partials/course_cards.html' %}
</section>

{% include 'education/partials/pagination_block.html' %}

{% if next_page_number %}
<div class="load-more-wrap">
    <button
        id="load-more-courses"
        class="btn btn-primary"
        data-next-page="{{ next_page_number }}"
        data-q="{{ query }}"
        data-category="{% if selected_category %}{{ selected_category }}{% endif %}">
        Показать ещё
    </button>
</div>
{% endif %}

<script>
    (function () {
        const btn = document.getElementById('load-more-courses');
        const grid = document.getElementById('course-grid');
        if (!btn || !grid) return;

        btn.addEventListener('click', async function () {
            if (btn.disabled) return;
            const nextPage = btn.dataset.nextPage;
            if (!nextPage) return;

            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Загрузка...';

            const params = new URLSearchParams();
            params.set('page', nextPage);
            params.set('partial', 'courses');
            if (btn.dataset.q) params.set('q', btn.dataset.q);
            if (btn.dataset.category) params.set('category', btn.dataset.category);

            try {
                const response = await fetch(`{% url 'education_courses' %}?${params.toString()}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error('Bad response');
                const html = await response.text();
                const temp = document.createElement('div');
                temp.innerHTML = html;
                while (temp.firstChild) {
                    grid.appendChild(temp.firstChild);
                }

                const next = parseInt(nextPage, 10) + 1;
                const totalPages = {{ page_obj.paginator.num_pages|default:1 }};
                if (next > totalPages) {
                    btn.remove();
                    return;
                }
                btn.dataset.nextPage = String(next);
                btn.disabled = false;
                btn.textContent = originalText;
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'Повторить загрузку';
            }
        });
    })();
</script>
{% endblock %}
